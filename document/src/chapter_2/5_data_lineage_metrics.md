# 2.5 Алгоритмы оценки эффективности линии формирования данных

На основе сформированной абстрактной модели представления линии формирования
данных можно проводить оценку её эффективности. При этом, показатели эффективности
могут формироваться как для всего графа трансформаций, так и для каждого узла по
отдельности. Это позволяет проводить сравнительную характеристику в процессе
оптимизации программного кода, поскольку на каждой итерации линия данных
может быть подвержена изменениям с точки зрения последовательности трансформаций,
а также определять узкие места в расчёте формируемого отчёта, позволяя 
акцентировать внимание разработчика на наиболее слабые с точки зрения эффективности
выполнения трансформации.

Оценка эффективности линии формирования данных основывается на анализе структуры
выполняемых в ней трансформаций и позволяет получить агрегированный результат 
эффективности всего графа целиком. Поскольку в основе линии формирования данных
лежит направленный ациклический граф с единственным конечным узлом, для расчёта 
показателей эффективности будут использоваться алгоритмы обходы дерева в 
ширину и глубину. Обход дерева в ширину подходит для задач накопительного
расчёта показателей на основе значений на каждом узле трансформации внутри графа,
обход в глубину же подходит для метрик, которые используют в качестве основы 
для расчёта показателей глубину графа. 

Глубина расчёта линии данных является одним из наглядных показателей, поскольку 
определяется как глубина соответствующего графа. Чем глубже дерево линии даных, 
тем больше в графе производится промежуточных расчётов до конечной витрины, 
что влияет на потребление вычислительных ресурсов. Слишком глубокое дерево 
будет иметь достаточно высокий уровень потребления ресурсов как диска, так и 
используемой оперативной памяти, что может повлиять также на время выполнения
всей линии формирования данных. При слишком долгом выполнении может 
возникнуть ситуация, в которой параллельно выполняемые процессы могут 
конкурировать за ресурсы, в результате чего перегрузить весь вычислительный кластер и
нарушить работу всех процессов. Каждое такое "падение" процесса для слишком
большого графа будет значительным, поскольку необходимо проводить полный перерасчёт
всех шагов трансформации.

Ещё одним показателем, связанным с общим качеством формируемой линии данных является
степень материализации. Данный показатель позволяет отслеживать в анализируемой линии
данных проблемные трансформации, которые не имеют промежуточной материализации, в результате
чего прим выполнении данных преобразовании требовать большого объёма оперативной памяти. Если
же в вычислительном конктуре не будет хватать оперативной памяти, СУБД будет самостоятельно
отгружать часть рассчитанных файлов на диск, формируя spill-файлы. Хоть spill-файлы в какой-то
степени самостоятельно решают задачу материализации тяжелых по ресурсам расчётов, однако
пользователь никак не может контролировать объём их формирования и процесс высвобождения памяти,
что рано или поздно может привести к непредвиденному заполнению диска. Степень 
материализации линии данных определяется как отношение максимальной глубины
материализованного расчёта к глубине расчёта линии данных.

Степень перерасчёта линии данных определяет то, насколько часто таблицы-источники используются
повторно в запросах. Каждый повторный запрос к таблице в рамках линии данных требует полного 
и повторного чтения данных из таблицы, что не является оптимальным решением при анализе
достаточно большого объёма данных. Под степенью перерасчёта линии данных понимается отношение
числа источников данных к накопительной сумме ссылок на материализованные объекты 
линии данных. Накопительная сумма ссылок на материализованные объекты предполагает, что
каждая нематериализованная трансформация над данными так или иначе соприкасается с 
материализованными объектами данных, следовательно, каждое новое использование объекта будет
требовать повторное считывание и перерасчёт. Накопительная сумма считается для каждого узла 
следующим образом: если текущая трансформация является материализованной, то накопительная
сумма не будет считать и необходимо вернуть значение, равное 1, иначе должна быть посчитанная 
сумма этой же накопительной суммы для всех предков данного узла. Следовательно, данная
накопительная сумма для конечного узла будет являться итоговой суммой для степени
перерасчёта линии данных.

Для оценки эффектиности линии данных на уровне каждой трансформации необходимо проводить
более глубокую детализацию измеримых значений, делать акценты на более атомарных процессах
внутри каждого преобразования над данными. К одному из таких отслеживаемых процессов можно 
отнести определение порядка соединения таблиц в трансформации данных. В современных СУБД 
процесс соединения данных происходит последовательно, осуществляя подготовку и сортировку
таблиц в соответствии с условием для оптимизации вычислений. Каждая смена условия соединения
предполагает пересортировку наборов данных под конкретные поля. Если выстроить условия
соединения таблиц последовательно друг за другом, чтобы одни и те же поля соединения были 
рядом, это сократит число выполняемых перераспределений в данных. Таким образом, для каждого
узла можно определить метрику "монотонности соединения таблиц", тем самым проводя оценку 
эффективности выстроенной последовательности. Данная метрика определяется как отношение 
числа смены условий соединения к числу уникальных условий соединения. При помощи данного
показателя можно отслеживать узлы трансформаций с плохой оптимизацией. 

Таким образом, сформированные показатели эффективности линии данных позволяют 
проводить более измеримый процесс оптимизации программного кода с точки зрения
оптимизации производимых вычислений. Между итерациями оптимизации показатели 
будут изменяться и приводить к дальнейшим этапам оптимизации. Показатели, 
которые рассчитываются на всю линию данных, определяют её эффективность
по отношению к другим графам, а метрики, вычисляемые для каждого узла 
трансформации необходимы для поиска узких мест в оптимизации, требующих
дополнительной проработки вне контекста самой линии формирования данных.