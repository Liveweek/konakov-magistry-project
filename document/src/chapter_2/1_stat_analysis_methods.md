# 2.1 Анализ методов статического анализа SQL-запросов

Язык структурированных запросов SQL является одним из самых популярных языков для работы 
с реляционными базами данных. SQL-запросы используются для создания, изменения 
и извлечения данных из базы данных. SQL как язык имеет собственный набор стандартов, 
который описывает структуру запроса и перечень базовых функций, предназначенных для
работы с встроенными типами данных (целочисленные значения, числа с плавающей точкой,
строковые значения, данные формат "дата-время" и другие). Благодаря этим стандартам,
базовые конструкции запроса в разных СУБД имеют схожий синтаксис, что позволяет 
проводить статический анализ запросов на основе базовых правил и шаблонов.

Существует несколько методов статического анализа SQL-запросов, которые позволяют
провести исследование программного кода, среди которых можно выделить следующие:

- анализ кода при помощи регулярных выражений;

- анализ как последовательности разделов програмного кода (токенов);

- анализ кода как абстрактного синтаксического дерева (AST).

Анализ SQL-запросов при помощи регулярных выражений предполагает поиск в 
программном коде подстрок в соответствии с заданным шаблоном (регулярным выражением).
Корректно составленное шаблонное выражение позволяет эффективно и однозначно 
искать нужные элементы кода, необходимые для анализа. Например, при помощи
регулярных выражений можно проводить проверку программного кода на соответствие
правилам наименования объектов (Naming convention) и находить классические
ошибки при написании запросов к базам данных или другим системам, которые используют
язык SQL как инструмент для описания трансформаций над данными. Использование
регулярных выражений для статического анализа SQL-запросов также применяется для
поиска уязвимостей веб-приложений, которые используют РСУБД для работы
с данными. Основная часть уязвимостей, связанных с SQL-запросами, происходит
из возможности написания вредоносного кода на месте заполняемых 
параметров запроса, вводимых пользователем (SQL-инъекции). Таким образом,
при помощи регулярных выражений для SQL-запросов можно задавать шаблоны, которые
будут описывать наиболее уявимые для инъекций элементы кода.

Статический анализ исходного кода в базовом понимании опирается 
на разбор последовательности элементов синтаксиса (токенов), каждый из которых
запускает процесс считываения и анализа последующих элементов. Конечный набор
токенов, ограниченный скобками или другими элементами конструкции (табуляцией, точкой
с запятой и т.д.), образует логическую единицу, которая может быть проанализирована и
преобразована компилятором в набор команд машинного кода. Также данная логическая единица
программного кода может быть проанализирована пользователем с точки зрения использования
конкретных конструкций языка. Однако, для того, чтобы последовательность токенов 
воспринималась программой анализа наиболее эффективно, предварительно проводится
преобразование последовательности токенов в другой порядок. Например, применив 
метод "Обратной польской записи", можно выстроить элементы запроса таким образом,
чтобы иметь возможность провести анализ запроса для каждого участка запроса
отдельно: отдельно проанализировать перечень определённых колонок в SELECT, 
рассмотреть набор используемых в запросе таблиц и их взаимосвязь в FROM, а 
также параметры фильтрации и сортировки в WHERE и ORDER BY (Ссылка на рисунок).

<!-- ! Рисунок про обратную польскую запись для SQL-запроса -->

Таким образом, для каждого раздела SQL-запроса можно провести собственный
анализ, формализовать проверки выполняемых вычислений над колонками таблиц,
определять неоптимальные условие соединения таблиц и другие аспекты, которые
могут быть важны для оптимизации запроса.

Статический анализ SQL-запроса также можно свести к анализу абстрактного
синтаксического дерева (Abstract Syntax Tree, AST). Абстрактное синтаксическое
дерево – это древовидное представление исходного кода программы, в котором 
каждый узел представляет конструкцию, встречающуюся в исходном коде. 
AST обычно используется компиляторами и интерпретаторами для анализа 
и трансляции программы в исполняемый код. SQL также можно представить в
виде AST-дерева, где каждый элемент синтаксиса (системные выражения, названия таблиц и 
их псевдонимы, названия функций и аргументы) будет представлена отдельным узлом, при
этом вложенные элементы объекта будут являться непосредственными предками
этого узла в дереве (Ссылка на рисунок).

<!-- ! Рисунок абстрактного синтаксического дерева над SQL -->

Организация статического анализа при помощи абстрактного
синтаксического дерева позволяет проводить анализ программного кода только на
определённой глубине дерева, тем самым анализируя только необходимые элементы запроса.
Также AST позволяет проводить анализ только для конкретных видов узлов и его конкретных предков,
например, это может использоваться для анализа таблиц, которые используются для 
формирования итогового запроса. 

<!-- TODO: Вывод по разделу -->
Таким образом, статический анализ SQL-запросов имеет несколько методов реализации,
в результате которых можно провести аналитику запроса под разные задачи: поиск уязвимых
мест к SQL-инъекциям, оптимизация запроса, анализ запроса на соответствие стандартам
наименования объектов и другие. Каждый метод анализа имеет свои преимущества с точки
зрения эффективности работы под конкретные задачи. Однако наиболее гибким и универсальным
методом является анализ SQL-запроса как абстрактного синтаксического дерева, так как
он позволяет проводить анализ запроса на разных уровнях вложенности и для разных
элементов запроса.